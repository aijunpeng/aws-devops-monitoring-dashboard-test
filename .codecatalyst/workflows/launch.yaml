Name: deploy
SchemaVersion: "1.0"
Triggers:
  - Type: PUSH
    Branches:
      - main
Compute:
  Type: EC2
  Fleet: Linux.x86-64.Large
Actions:
  deploy-hub:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
      Variables:
        - Name: LAUNCH_OPTIONS_DIST_VERSION
          Value: v1.8.8
        - Name: LAUNCH_OPTIONS_QuickSightSourceTemplateArn
          Value: arn:aws:quicksight:us-east-1:423991167869:template/solutions_aws-devops-monitoring-dashboard_v1_8_8
        - Name: LAUNCH_OPTIONS_QuickSightPrincipalArn
          Value: arn:aws:quicksight:us-east-1:960435647188:user/default/bluebeard6-admin/penaijun-Isengard
        - Name: LAUNCH_OPTIONS_UseGitHub
          Value: "Yes"
        - Name: LAUNCH_OPTIONS_WebhookSecretToken
          Value: "test_token"
        - Name: LAUNCH_OPTIONS_AllowedIPs
          Value: "192.30.252.0/22,185.199.108.0/22,140.82.112.0/20,143.55.64.0/20"
        - Name: LAUNCH_OPTIONS_CodeCommitRepo
          Value: "'ALL'"
        - Name: LAUNCH_OPTIONS_DataDuration
          Value: 90
        - Name: LAUNCH_OPTIONS_PrincipalType
          Value: "AWS Account Number"
        - Name: LAUNCH_OPTIONS_PrincipalList
          Value: "030552015774"
        - Name: LAUNCH_OPTIONS_S3TransitionDays
          Value: 365
        - Name: LAUNCH_OPTIONS_TagsConfigCodeCommit
          Value: "env,prod"
        - Name: LAUNCH_OPTIONS_TagsConfigCodeBuild
          Value: "env,prod"
        - Name: LAUNCH_OPTIONS_TagsConfigCodePipeline
          Value: "env,staging"
    Outputs:
      AutoDiscoverReports:
        Enabled: false
        ReportNamePrefix: rpt
    Configuration:
      Steps:
        - Run: cd source
        - Run: npm install
        - Run: chmod +x ../.codecatalyst/workflows/set_solution_env.sh && source ../.codecatalyst/workflows/set_solution_env.sh
        - Run: npx cdk bootstrap
        - Run: npm run build
        - Run: npx cdk synth --context quicksight_source_template_arn=$LAUNCH_OPTIONS_QuickSightSourceTemplateArn
        - Run: npm run install-dependencies
        - Run: |
            echo $LAUNCH_OPTIONS_PrincipalType && npx cdk --app cdk.out deploy aws-devops-monitoring-dashboard --require-approval never \
            --parameters QuickSightPrincipalArn=$LAUNCH_OPTIONS_QuickSightPrincipalArn \
            --parameters UseGitHub=$LAUNCH_OPTIONS_UseGitHub \
            --parameters WebhookSecretToken=$LAUNCH_OPTIONS_WebhookSecretToken \
            --parameters AllowedIPs=$LAUNCH_OPTIONS_AllowedIPs \
            --parameters CodeCommitRepo=$LAUNCH_OPTIONS_CodeCommitRepo \
            --parameters DataDuration=$LAUNCH_OPTIONS_DataDuration \
            --parameters PrincipalType="$LAUNCH_OPTIONS_PrincipalType" \
            --parameters PrincipalList=$LAUNCH_OPTIONS_PrincipalList \
            --parameters S3TransitionDays=$LAUNCH_OPTIONS_S3TransitionDays \
            --parameters TagsConfigCodeCommit=$LAUNCH_OPTIONS_TagsConfigCodeCommit \
            --parameters TagsConfigCodeBuild=$LAUNCH_OPTIONS_TagsConfigCodeBuild \
            --parameters TagsConfigCodePipeline=$LAUNCH_OPTIONS_TagsConfigCodePipeline \
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-aijunsolutions
          Name: "960435647188"
      Name: dev_environment
    Timeout: 20
